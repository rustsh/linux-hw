## Домашнее задание к занятию № 17 — «Резервное копирование»    <!-- omit in toc -->

### Оглавление  <!-- omit in toc -->

- [Задание](#Задание)
- [Описание работы](#Описание-работы)
- [Проверка работы](#Проверка-работы)

### Задание

Снятие бэкапов с помощью BorgBackup.

Настроить стенд Vagrant с двумя виртуальными машинами: server и backup.

Настроить политику бэкапа директории **/etc** с клиента (server) на бэкап-сервер (backup):
1. Бэкап снимается раз в час.
2. Политика хранения бэкапов: хранятся все за последние 30 дней, и по одному за предыдущие два месяца.
3. Процесс бэкапа логируется в **/var/log/**.
4. Восстановить из бэкапа директорию **/etc** с помощью команды `borg mount`.

Результатом должен быть скрипт резервного копирования (политику хранения можно реализовать в нём же), а также вывод команд терминала.

Задание со *: настроить репозиторий для резервных копий с шифрованием ключом.

### Описание работы

При выполнении команды `vagrant up` поднимаются две виртуальные машины — server и backup, после чего запускается их настройка посредством Ansible.

Так как необходимо снимать резервные копии каталога **/etc**, запуск Borg производится из-под пользователя root.

Шаги предварительной настройки:

1. На обеих машинах устанавливается Borg — из официального репозитория скачивается бинарный файл и сохраняется в каталог **/bin**, ему выдаются права на выполнение (0755).
    
    > *Примечание*. Если скопировать файл в каталог **/usr/local/bin**, как это указано на официальном сайте, то запуск программы через Ansible вызовет ошибку, так как этого каталога нет в переменной `$PATH` пользователя root, из-под которого и выполняется плейбук (не помогает даже использование ключа `become_user`).

2. Для пользователя root на клиенте (машина server) генерируется пара SSH-ключей.
3. Открытый SSH-ключ копируется в файл **authorized_keys** на машине backup для доступа по SSH. Также для этого пользователя на клиенте создаётся [SSH config](provisioning/roles/deploy_key/templates/config.j2).
4. На бэкар-сервере создаётся директория для хранения бэкапов: **/opt/backups/files-etc**.
5. На клиенте выполняется команда инициализации удалённого репозитория с использованием шифрования (кодовая фраза задаётся в стартовом плейбуке и передаётся через переменную окружения `BORG_NEW_PASSPHRASE`). Если репозиторий уже существует (проверяется по наличию каталога **data** в директории для хранения бэкапов), этот шаг пропускается.
6. Параметризированный скрипт для снятия бэкапа [borg-etc.sh](provisioning/roles/run_borg/templates/borg-etc.sh.j2) копируется в каталог **/opt** на клиенте, ему выдаются права на выполнение.

    В скрипте задаётся нужная политика хранения бэкапов при помощи ключей команды `borg prune`: `--keep-within 30d` и `--keep-monthly 2`.

    Здесь же настраивается логирование работы скрипта в файл **/var/log/borg.log**. Для этого задано перенаправление вывода команд `borg create` и `borg prune` в нужный файл (по умолчанию Borg выводит всю информацию в stderr): `borg create [options] 2>> /var/log/borg.log`. Уровень логирования задаётся ключами этих команд, в данной работе используется `--verbose` (соответствует уровню логирования INFO).

    Кроме вывода команд, в файле лога фиксируются этапы работы Borg. При ручном запуске скрипта эта информация выводится также в консоль:

    ```bash
    info() { printf "#### %s %s ####\n" "$( date )" "$*" | tee -a /var/log/borg.log; }
    ...
    info "Starting backup"
    ```

7. В Cron настраивается выполнение скрипта каждый час:

    ```console
    [root@server ~]# crontab -l
    #Ansible: Create backup with Borg
    @hourly /opt/borg-etc.sh > /dev/null 2>&1
    ```

### Проверка работы



<br/>

[Вернуться к списку всех ДЗ](../README.md)