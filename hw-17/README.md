## Домашнее задание к занятию № 17 — «Резервное копирование»    <!-- omit in toc -->

### Оглавление  <!-- omit in toc -->

- [Задание](#Задание)
- [Описание работы](#Описание-работы)
- [Проверка работы](#Проверка-работы)

### Задание

Снятие бэкапов с помощью BorgBackup.

Настроить стенд Vagrant с двумя виртуальными машинами: server и backup.

Настроить политику бэкапа директории **/etc** с клиента (server) на бэкап-сервер (backup):
1. Бэкап снимается раз в час.
2. Политика хранения бэкапов: хранятся все за последние 30 дней, и по одному за предыдущие два месяца.
3. Процесс бэкапа логируется в **/var/log/**.
4. Восстановить из бэкапа директорию **/etc** с помощью команды `borg mount`.

Результатом должен быть скрипт резервного копирования (политику хранения можно реализовать в нём же), а также вывод команд терминала.

Задание со *: настроить репозиторий для резервных копий с шифрованием ключом.

### Описание работы

При выполнении команды `vagrant up` поднимаются две виртуальные машины — server и backup, после чего запускается их настройка посредством Ansible.

Шаги предварительной настройки:

1. На обеих машинах создаётся пользователь для снятия бэкапов (borg), для него генерируются SSH-ключи.
2. На обеих машинах устанавливается Borg — из официального репозитория скачивается бинарный файл и сохраняется в каталог **/bin**, ему выдаются права на выполнение (0755).
    
    > *Примечание*. Если скопировать файл в каталог **/usr/local/bin**, как это указано на официальном сайте, то запуск программы через Ansible вызовет ошибку, так как этого каталога нет в переменной `$PATH` пользователя root, из-под которого и выполняется плейбук (не помогает даже использование ключа `become_user`).

3. Открытый SSH-ключ пользователя borg с машины client копируется в файл **authorized_keys** на машине server для доступа по SSH. Также для этого пользователя на клиенте создаётся [SSH config](provisioning/roles/deploy_key/templates/config.j2).
4. На сервере создаётся директория для хранения бэкапов: **/home/borg/backup/files-etc**.
5. На клиенте выполняется команда инициализации удалённого репозитория с использованием шифрования.

    > *Примечание*. Чтобы во время работы Ansible передать программе Borg кодовое слово, которое вводится при выполнении команды `borg init -e repokey /path/to/repo`, необходим модуль Ansible expect, для которого, в свою очередь, нужно установить модуль Python pexpect.

6. Параметризированный [скрипт для снятия бэкапа](provisioning/roles/run_borg/templates/borg-etc.j2) копируется в домашний каталог пользователя borg на клиенте, ему выдаются права на выполнение.
7. В Cron настраивается выполнение скрипта каждые 15 минут.

Стуктура каталога:

```console
$ tree
.
├── ansible.cfg
├── provisioning
│   ├── group_vars
│   │   └── all
│   ├── roles
│   │   ├── deploy_key
│   │   │   ├── tasks
│   │   │   │   └── main.yml
│   │   │   └── templates
│   │   │       └── config.j2
│   │   ├── install_borg
│   │   │   └── tasks
│   │   │       └── main.yml
│   │   └── run_borg
│   │       ├── tasks
│   │       │   └── main.yml
│   │       └── templates
│   │           └── borg-etc.j2
│   └── start.yml
├── README.md
└── Vagrantfile
```

Политика очистки старых бэкапов настроена таким образом, чтобы хранить все бэкапы за последние два часа.

Поскольку резервные копии каталога **/etc** создаются под пользователем borg, к некоторым файлам и директориям доступ закрыт, и их нет в бэкапе.

### Проверка работы

1. Выполнить команду `vagrant up` и подождать какое-то время, достаточное для создания нескольких бэкапов (они создаются каждые 15 минут).
2. Подключиться к машине client при помощи команды `vagrant ssh client`, после чего залогиниться под пользователем borg:

    ```console
    [vagrant@localhost ~]$ sudo su - borg
    ```

3. Проверить, что резервные копии создались (не забудьте про кодовое слово):

    ```console
    [borg@localhost ~]$ borg list server:backup/files-etc
    Enter passphrase for key ssh://server/./backup/files-etc: 
    Warning: The repository at location ssh://server/./backup/files-etc was previously located at ssh://borg@server/home/borg/backup/files-etc
    Do you want to continue? [yN] y
    2020-03-13_07:15                     Fri, 2020-03-13 07:15:03 [d3d26e38e57a0c665ab5e8ac65e1a3f4b48405786f17563dbeb90ec907483119]
    2020-03-13_07:30                     Fri, 2020-03-13 07:30:04 [10fc928f73b100a0de110e0e751de3a7b3f409055e421a4a8c8deeeafffff6d1]
    2020-03-13_07:45                     Fri, 2020-03-13 07:45:03 [2533d561b77973c326e6428099c4c277a7898009ddb3e24e7545792458ec507d]
    2020-03-13_08:00                     Fri, 2020-03-13 08:00:03 [3fd9989e8195bd3d43a35f8d44ba7aaffd8dc64ebe50bdb58bcae860573fe0ca]
    ```

    Кодовое слово задаётся в основном Ansible-плейбуке, в данной работе это `qwerty123`.

4. Для проверки дедупликации создадим резервную копию вручную:

    ```console
    [borg@localhost ~]$ ./borg-etc.sh 
    
    ...
    
    ------------------------------------------------------------------------------
    Archive name: 2020-03-13_08:11
    Archive fingerprint: c196058d1121f2fa07393e6f3aff852e69291b2414b4ca94cafc467e6b84890a
    Time (start): Fri, 2020-03-13 08:11:25
    Time (end):   Fri, 2020-03-13 08:11:25
    Duration: 0.20 seconds
    Number of files: 408
    Utilization of max. archive size: 0%
    ------------------------------------------------------------------------------
                        Original size      Compressed size    Deduplicated size
    This archive:               16.90 MB              5.70 MB                562 B
    All archives:               84.52 MB             28.49 MB              5.74 MB

                        Unique chunks         Total chunks
    Chunk index:                     407                 2030
    ------------------------------------------------------------------------------
    ```

<br/>

[Вернуться к списку всех ДЗ](../README.md)