## Домашнее задание к занятию № 9 — «Пользователи и группы. Авторизация и аутентификация»    <!-- omit in toc -->

### Оглавление  <!-- omit in toc -->

- [Задание](#Задание)
- [Описание работы](#Описание-работы)
- [Проверка](#Проверка)

### Задание

Используя PAM, запретить всем пользователям, кроме группы admin, логин в выходные (суббота и воскресенье) без учёта праздников.

### Описание работы

При выполнении команды `vagrant up` поднимается виртуальная машина с CentOS 7 и запускается скрипт предварительной настройки [start.sh](start.sh), в ходе выполнения которого:

1. Создаются новые пользователи **first** и **second**, им назначаются пароли.
2. Создаётся группа **admin**, в неё добавляется один из новых пользователей (**first**), а также пользователь **vagrant** (чтобы не терять контроль над машиной).
3. В файле конфигурации SSH включается вход по паролю.
4. В директорию **/usr/local/bin/** копируется и делается исполняемым файл [check_login.sh](check_login.sh), который является скриптом проверки.
5. В файл сценария PAM для sshd (**/etc/pam.d/sshd**) включается использование модуля pam_exec.so с полным путём до скрипта проверки в качестве параметра.

Скрипт проверки [check_login.sh](check_login.sh) пробегает по всем группам заданного пользователя, и если там нет группы **admin**, то вычисляет, какой сегодня день недели. Если это выходные (суббота или воскресение), то он возвращает 1 (запрет доступа), иначе 0:

```bash
#!/usr/bin/env bash
check=$(groups $PAM_USER | awk '{ for (k=3; k<=NF; k++) {if ($k=="admin") print $k } }')
if [[ -z $check ]]
then
    if [[ $(date +%a) = "Sat" || $(date +%a) = "Sun" ]]
    then
        exit 1
    else
        exit 0
    fi
fi
```

### Проверка

1. Подставить в скрипт [check_login.sh](check_login.sh) текущий день недели (если сегодня будний день).
2. Создать виртуальную машину, выполнив команду `vagrant up`.
3. Подключиться к ней по SSH, используя логин **first**, и убедиться, что доступ есть:

    ```console
    $ ssh first@192.168.33.10
    first@192.168.33.10's password: 
    [first@localhost ~]$ whoami
    first
    ```

    IP-адрес задаётся в [Vagrantfile](Vagrantfile), пароль — в [файле предварительной настройки](start.sh) (в данной работе это `Qwerty123`).

4. Подключиться к виртуальной машине по SSH, используя логин **second**, и убедиться, что доступ запрещён:

    ```console
    $ ssh second@192.168.33.10
    second@192.168.33.10's password: 
    /usr/local/bin/check_login.sh failed: exit code 1
    Connection closed by 192.168.33.10 port 22
    $
    ```

5. Зайти в виртуальную машину при помощи команды `vagrant ssh` и удалить из скрипта **/usr/local/bin/check_login.sh** текущий день недели.
6. Ещё раз подключиться к виртуальной машине по SSH с логином **second**. Доступ должен появиться:

```console
$ ssh second@192.168.33.10
second@192.168.33.10's password: 
Last failed login: Wed Mar  4 19:46:52 UTC 2020 from 192.168.33.1 on ssh:notty
[second@localhost ~]$ whoami
second
```

<br/>

[Вернуться к списку всех ДЗ](../README.md)