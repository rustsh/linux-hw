---
- name: Config iptables on inetRouter
  iptables:
    table: nat
    action: append
    chain: POSTROUTING
    destination: '! 192.168.0.0/16'
    out_interface: eth0
    jump: MASQUERADE
  when: inventory_hostname == "inetRouter"

- name: Enable forwading on routers
  copy:
    src: forwarding.conf
    dest: /etc/sysctl.d/forwarding.conf
  when: "'Router' in inventory_hostname"
  notify:
    - Restart network

- name: Config default route
  include: default_route.yml
  when: inventory_hostname != "inetRouter"

- name: Set default gateway on eth1
  vars:
    host: "{{inventory_hostname}}"
  ini_file:
    path: /etc/sysconfig/network-scripts/ifcfg-eth1
    section: null
    option: GATEWAY
    value: "{{ vars[host].eth1.gateway }}"
    no_extra_spaces: yes
  when:
    - inventory_hostname != "inetRouter"
    - vars[host].eth1.gateway is defined
  notify:
    - Restart network

- name: Copy route files
  template:
    src: "{{ item }}"
    dest: /etc/sysconfig/network-scripts/{{ item | basename | regex_replace('\.j2$', '') }}
  with_fileglob:
    - "{{ role_path }}/templates/{{ inventory_hostname }}/*.j2"
  notify:
    - Restart network

# После поднятия хоста сервис network находится в статусе failed c ошибкой "Connection activation
# failed: No suitable device found for this connection" для интерфейса eth0 из-за NetworkManager.
# После рестарта сервиса, вызванного в хэндлере, ошибка пропадает, но изменения из файлов route-eth*
# не подтягиваются. Чтобы они вступили в силу, рестартовать должен уже запущенный сервис.
# Для этого и нужен следующий таск
- name: Start network service
  systemd:
    name: network
    state: started
    enabled: yes

- name: Stop and disable NetworkManager
  systemd:
    name: NetworkManager
    state: stopped
    enabled: no
